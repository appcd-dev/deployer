name: Build and Push with Git Tag

# 1. Trigger on *any* tag push
on:
  push:
    tags:
      - "*"  # or use "v*" if you only tag with a "v" prefix

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      # 2. Extract tag from GITHUB_REF_NAME (e.g. refs/tags/v1.2.3 -> v1.2.3)
      - name: Extract Tag
        id: extract_tag
        run: |
          # GITHUB_REF_NAME might be "v1.2.3" or "1.2.3", depending on how you push your tag
          # If you want to remove 'refs/tags/' prefix (in older GITHUB_REF), you can do:
          #   echo "TAG_VERSION=${GITHUB_REF_NAME#refs/tags/}" >> $GITHUB_OUTPUT
          # If you want to remove a leading 'v', do:
          #   echo "TAG_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      # 3. Authenticate to GCR using your service account key in GCP_SA_KEY
      - name: Log in to GCR
        uses: docker/login-action@v2
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # 4. Build using the extracted tag as the VERSION
      - name: Build Deployer
        run: |
          cd deployer-image
          make build VERSION="${{ steps.extract_tag.outputs.TAG_VERSION }}"

      # 5. Push using the extracted tag
      - name: Push Deployer
        run: |
          cd deployer-image
          make push VERSION="${{ steps.extract_tag.outputs.TAG_VERSION }}"
